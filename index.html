<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국형 사회성 검사(KSIP)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #34495e; --bg: #f8f9fa; --text: #333; }
        body { font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); display: flex; justify-content: center; line-height: 1.6; }
        .container { max-width: 800px; width: 100%; background: white; padding: 40px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e1e1e1; }
        
        /* 제목 (치트키) */
        h1 { text-align: center; color: var(--primary); margin-bottom: 20px; font-size: 1.8rem; font-weight: 700; user-select: none; }
        h3 { border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-top: 40px; margin-bottom: 15px; color: var(--primary); font-size: 1.2rem; }
        
        /* 로딩 화면 */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #eee; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 질문 박스 */
        .question-box { background: #fff; margin-bottom: 20px; padding: 0 0 20px 0; border-bottom: 1px solid #eee; }
        .options { display: flex; gap: 0; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .option-label { flex: 1; cursor: pointer; } 
        .option-label input { display: none; }
        .btn-text { width: 100%; height: 45px; display: flex; align-items: center; justify-content: center; background: #fff; font-size: 0.85rem; border-right: 1px solid #ddd; color: #666; transition: 0.2s; }
        .option-label:last-child .btn-text { border-right: none; }
        .option-label input:checked + .btn-text { background: var(--primary); color: white; font-weight: bold; }

        /* 결과 화면 */
        #result-area { display: none; }
        
        /* 결과 요약 박스 */
        .one-liner-box { background: #f1f2f6; border-left: 5px solid var(--primary); padding: 20px; margin-bottom: 30px; }
        .one-liner-sub { font-size: 0.9rem; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .one-liner-main { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        /* 순위 박스 */
        .rank-container { display: flex; gap: 20px; margin: 20px 0; }
        .rank-box { flex: 1; padding: 20px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        .rank-title { font-weight: bold; margin-bottom: 10px; display: block; font-size: 1rem; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rank-list span { display: block; margin-bottom: 5px; font-size: 0.95rem; color: #555; }

        /* AI 결과 박스 스타일 */
        .ai-btn-area { text-align: center; margin: 40px 0; padding: 30px; background: #f9f9f9; border: 1px solid #eee; border-radius: 5px; }
        .ai-box { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin-bottom: 0; /* 마진 제거 (그룹 wrapper에서 처리) */
            line-height: 1.8; 
            font-size: 0.95rem; 
            text-align: justify; 
            color: #444; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .ai-box strong { color: #000; font-weight: 700; }
        
        /* ★★★ [중요] PDF 저장 시 부제목+내용이 같이 다니도록 묶어주는 클래스 */
        .ai-section-group {
            page-break-inside: avoid; /* 이 그룹 안에서는 페이지를 나누지 않음 */
            margin-bottom: 30px;      /* 그룹 간 간격 */
            display: block;           /* 블록 요소로 확실하게 처리 */
        }
        
        /* 버튼 */
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; transition: 0.2s; }
        #submit-btn { background-color: var(--primary); }
        #ai-btn { background-color: #3498db; }
        #pdf-btn { background-color: #27ae60; }
        #retry-btn { background-color: #95a5a6; }
        
        .chart-container { position: relative; height: 300px; margin-top: 20px; page-break-inside: avoid; }
        
        /* 테이블 */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; border-top: 2px solid #333; }
        .detail-table th, .detail-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .detail-table th { background: #f8f9fa; font-weight: bold; }
        .detail-table tr { page-break-inside: avoid; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <h3 style="border:none; margin:0; color:#555;">심층 분석 중입니다</h3>
    <p style="font-size:0.9rem; color:#888;">약 10~30초 정도 소요됩니다.</p>
</div>

<div class="container">
    <div id="quiz-area">
        <h1 id="main-title" title="3번 클릭 시 자동 체크">한국형 사회성 검사(KSIP)</h1>
        
        <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:30px; font-size:0.9rem; color:#666;">
            <strong>[검사 안내]</strong><br>
            각 문항을 읽고 자신에게 해당하는 정도를 선택하십시오.<br>
            (1: 전혀 그렇지 않다 ~ 5: 매우 그렇다)
        </div>
        <form id="quiz-form"></form>
        <button id="submit-btn" class="action-btn" onclick="calculateResult()">검사 결과 분석</button>
    </div>

    <div id="result-area">
        <div id="pdf-content" style="padding: 20px; background: white;">
            
            <div style="margin-bottom: 30px;">
                <h1 style="margin-top:0; font-size: 1.8rem; text-align:left; border-bottom:2px solid #333; padding-bottom:10px;">KSIP 심리 평가 보고서</h1>
                <p style="font-size:0.9rem; color:#777;">본 보고서는 KSIP 검사 결과를 바탕으로 AI 임상 분석 시스템에 의해 생성되었습니다.</p>
                
                <div class="one-liner-box">
                    <div id="result-subtitle" class="one-liner-sub">PRIMARY PROFILE</div>
                    <div id="result-main-title" class="one-liner-main"></div>
                </div>
            </div>

            <div>
                <h3>1. 유형별 점수 요약</h3>
                <div class="rank-container">
                    <div class="rank-box">
                        <span class="rank-title">높은 점수 (핵심 기제)</span>
                        <div id="high-rank-list" class="rank-list"></div>
                    </div>
                    <div class="rank-box">
                        <span class="rank-title">낮은 점수 (보완점)</span>
                        <div id="low-rank-list" class="rank-list"></div>
                    </div>
                </div>
            </div>

            <div id="ai-trigger-area" class="ai-btn-area">
                <h3 style="margin:0 0 10px 0; border:none; padding:0; color:#333;">AI 심층 분석 요청</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">
                    전문 상담 수준의 심층 분석 리포트를 생성합니다.<br>
                    (약 10~30초 소요)
                </p>
                <button id="ai-btn" class="action-btn" onclick="callAppsScript()">심층 분석 시작하기</button>
            </div>

            <div id="ai-result-container" style="display:none; margin-top: 30px;">
                <h3>2. 심층 심리 분석</h3>
                
                <div class="ai-section-group">
                    <h4 style="margin-bottom:10px; color:#2c3e50;">[핵심 무기와 잠재력]</h4>
                    <div id="ai-strength" class="ai-box"></div>
                </div>

                <div class="ai-section-group">
                    <h4 style="margin-bottom:10px; color:#2c3e50;">[내면의 그림자와 보완점]</h4>
                    <div id="ai-weakness" class="ai-box"></div>
                </div>

                <div class="ai-section-group">
                    <h4 style="margin-bottom:10px; color:#2c3e50;">[전문 상담 제안]</h4>
                    <div id="ai-advice" class="ai-box" style="border-left: 4px solid #27ae60;"></div>
                </div>
            </div>

            <div style="page-break-inside: avoid; margin-top: 40px;">
                <h3>3. 유형별 분포도</h3>
                <div class="chart-container"><canvas id="resultChart"></canvas></div>
                <div style="text-align:right; font-size:0.8rem; color:#888; margin-top:10px;">
                    * SQ 지수: <strong id="sq-score-text">0</strong>점
                </div>
            </div>

            <div style="margin-top:40px;">
                <h3>4. 문항별 응답 상세</h3>
                <table class="detail-table" id="detail-table">
                    <thead><tr><th>유형</th><th>문항 내용</th><th>점수</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>

        <div style="display:flex; gap:10px; margin-top:30px;">
            <button id="pdf-btn" class="action-btn" onclick="savePDF()">PDF 보고서 저장</button>
            <button id="retry-btn" class="action-btn" onclick="location.reload()">새 검사 시작</button>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ★★★ [중요] 배포한 Apps Script URL 입력 ★★★
    // ============================================================
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymXtdueUHPE7bkNOomJh4GGZv2eRaoY41-zn2TsxudQkcMsZOXfCZo7Idt-PokJitEjQ/exec"; 

    // 치트키
    let titleClickCount = 0;
    document.getElementById('main-title').addEventListener('click', function() {
        titleClickCount++;
        if (titleClickCount === 3) {
            const totalQuestions = document.querySelectorAll('.question-box').length;
            for (let i = 0; i < totalQuestions; i++) {
                const randomVal = Math.floor(Math.random() * 5) + 1; 
                document.getElementsByName(`q${i}`)[randomVal - 1].checked = true;
            }
            alert("테스트 모드: 자동 입력 완료");
            titleClickCount = 0;
        }
    });

    const typeNamesMap = {
        "1": "1번(소)", "2": "2번(강아지)", "3": "3번(독수리)",
        "4": "4번(고양이)", "5": "5번(부엉이)", "6": "6번(사슴)",
        "7": "7번(원숭이)", "8": "8번(호랑이)", "9": "9번(코끼리)"
    };

    const rawQuestions = [
        { q: "나는 모든 일을 개선하기 위해 깊이 생각해서 행동한다.", type: "1" }, { q: "나는 때때로 분노를 느낀다.", type: "1" }, { q: "나는 도덕적으로 자제력이 있는 사람이다.", type: "1" }, { q: "나의 행동은 원칙에 기초를 둔다.", type: "1" }, { q: "나는 완벽을 위해 끝까지 노력한다.", type: "1" }, { q: "나는 때때로 엄격하여 융통성이 없다.", type: "1" }, { q: "나는 다른 사람들로부터 신임을 얻고 있다.", type: "1" }, { q: "나는 옳고 그름이 분명하여 때로 비판적이다.", type: "1" }, { q: "나는 주로 나의 양심과 이성에 따라 행동한다.", type: "1" },
        { q: "나는 다른 사람들과 함께 일하기를 더 좋아한다.", type: "2" }, { q: "나의 관심사는 다른 사람들을 도와주는 것이다.", type: "2" }, { q: "나는 사람들을 지나치게 칭찬한다.", type: "2" }, { q: "내 생각보다는 남의 생각에 공감할 때가 많다.", type: "2" }, { q: "나는 친구들을 도와줄 때 기분이 좋다.", type: "2" }, { q: "나는 사람들을 관심 있게 대하고 보살피려 한다.", type: "2" }, { q: "나는 사람들과 친해지려고 많이 노력하고 있다.", type: "2" }, { q: "나는 타인의 감정을 위해 자신을 희생하기도 한다.", type: "2" }, { q: "나는 타인의 호감을 얻기 위해 아첨하기도 한다.", type: "2" },
        { q: "나는 능력을 발휘하는 데 많은 시간을 투자한다.", type: "3" }, { q: "나는 과정보다는 결과가 중요하다.", type: "3" }, { q: "나는 인간 중심적이기 보다는 오히려 목표 중심적이다.", type: "3" }, { q: "나는 적응력이 뛰어나 상황에 적절히 대응한다.", type: "3" }, { q: "나는 지나치게 경쟁한다.", type: "3" }, { q: "나는 사람들에 대한 배려보다는 일의 성취를 더 중요하게 생각한다.", type: "3" }, { q: "나는 성공이 애정을 획득할 수 있다고 믿는다.", type: "3" }, { q: "나는 맡은 일을 효율적으로 한다.", type: "3" }, { q: "나는 뒤떨어지지 않기 위해 무엇인가를 끊임없이 행한다.", type: "3" },
        { q: "나는 감성적이어서 혼자 있을 때가 많다.", type: "4" }, { q: "나는 혼자서 자신만의 고상한 취미를 즐긴다.", type: "4" }, { q: "나는 낭만적이고 예술가적 기질이 있다.", type: "4" }, { q: "나는 이방인처럼 느낄 때가 있다.", type: "4" }, { q: "나는 다른 사람보다 독특한 감정을 가지고 있다.", type: "4" }, { q: "나는 때로 분위기에 따라 나의 감정이 변한다.", type: "4" }, { q: "나는 마음이 따뜻하지만 때로 질투심이 난다.", type: "4" }, { q: "나는 감동적인 것을 추구하다가 혼자 우울해지기도 한다.", type: "4" }, { q: "나는 평범한 삶의 방식을 싫어한다.", type: "4" },
        { q: "나는 무엇인가에 집중하여 통찰한다.", type: "5" }, { q: "나는 문제가 있으면 풀릴 때까지 그것만 골똘히 생각한다.", type: "5" }, { q: "나는 공적인 것보다는 개인생활에 대한 관심이 많다.", type: "5" }, { q: "나는 분석적인 사고를 가지고 있다.", type: "5" }, { q: "나는 시간이나 돈을 아끼는 경향이 있다.", type: "5" }, { q: "나의 관심사는 나를 둘러싼 세계를 이해하는 것이다.", type: "5" }, { q: "나는 스스로 고립하여 고민하기도 한다.", type: "5" }, { q: "나는 지적으로 냉철하게 관찰하는 편이다.", type: "5" }, { q: "나는 머리로 모든 것을 이해하고 판단한다.", type: "5" },
        { q: "나는 명확한 지침이 있을 때 일의 능률이 오른다.", type: "6" }, { q: "나는 사랑하는 사람을 가끔 의심하는 경향이 있다.", type: "6" }, { q: "나는 가끔 자신을 부정하거나 의심한다.", type: "6" }, { q: "나는 소속 집단에 협력하여 책임감을 발휘한다.", type: "6" }, { q: "나는 모든 일에서 안전을 중요하게 생각한다.", type: "6" }, { q: "사람들은 나에게 용기가 필요하다고 말한다.", type: "6" }, { q: "나는 결과에 대한 두려움 때문에 일을 질질 끄는 경우가 있다.", type: "6" }, { q: "나는 충성할 만한 사람에게는 헌신할 수 있다.", type: "6" }, { q: "나는 친하게 지내는 사람과 영원한 우정을 유지하도록 노력한다.", type: "6" },
        { q: "나는 자발적으로 재미있는 일을 즐긴다.", type: "7" }, { q: "나는 모험적이다.", type: "7" }, { q: "나는 끊임없이 변화하는 생활을 좋아한다.", type: "7" }, { q: "나는 자극과 흥분을 유발하는 활동을 좋아한다.", type: "7" }, { q: "나는 때때로 어린아이처럼 유쾌하다.", type: "7" }, { q: "나는 낙천적으로 세상을 살아간다.", type: "7" }, { q: "나는 여러가지 새로운 경험을 추구한다.", type: "7" }, { q: "나는 한 가지 일에 정착하기가 어렵다.", type: "7" }, { q: "나는 참을성이 없는 편이다.", type: "7" },
        { q: "나에게는 지도자로서의 기질이 있다.", type: "8" }, { q: "나는 나의 뜻대로 결정하려고 한다.", type: "8" }, { q: "나는 늘 강해야 된다고 생각한다.", type: "8" }, { q: "나는 사람들을 지배하려는 경향이 있다.", type: "8" }, { q: "나는 일을 과감하게 추진한다.", type: "8" }, { q: "나는 공격적으로 자기주장을 말한다.", type: "8" }, { q: "나는 사람들을 통제하려 한다.", type: "8" }, { q: "나는 사람들을 지시하여 동기를 부여한다. ", type: "8" }, { q: "나는 강한 자신감으로 사람들을 설득시킨다.", type: "8" },
        { q: "나는 자기만족적이며 태평한 편이다.", type: "9" }, { q: "나는 게으른 편이다", type: "9" }, { q: "나는 모든 일들이 순조롭게 되길 원한다.", type: "9" }, { q: "나는 속상한 일들을 축소하려고 한다.", type: "9" }, { q: "나는 사람들과 좋은 관계를 유지하려 한다.", type: "9" }, { q: "나는 친구들의 의견에 동조하는 편이다.", type: "9" }, { q: "나는 세상의 일들과 조화롭게 흘러가고 싶다.", type: "9" }, { q: "나는 다른 사람들이 하는 일에 상관하지 않는 편이다.", type: "9" }, { q: "나는 조화로움을 추구하는 평화주의자다.", type: "9" },
        { q: "나는 때로는 운명이나 인연을 믿는다.", type: "SQ" }, { q: "나는 세상의 진리에 대해 궁금해 한 적이 있다.", type: "SQ" }, { q: "힘들때 나도 모르게 보이지 않는 것들(종교, 미신)에 의지한다.", type: "SQ" }, { q: "나는 소수라 하여도 아닌걸 아니라고 할 수 있다.", type: "SQ" }, { q: "나는 물질적인 것 보다 내면이 더욱 중요하다고 생각한다.", type: "SQ" }, { q: "나는 신의 존재를 믿는다.", type: "SQ" }, { q: "나는 언론이나 인터넷보다 실제로 보고 들은 것을 믿는 편이다.", type: "SQ" }, { q: "나는 약속을 잘 지킨다.", type: "SQ" }
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    const shuffledQuestions = shuffleArray([...rawQuestions]);
    const formContainer = document.getElementById('quiz-form');
    let finalScores = {};

    shuffledQuestions.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'question-box';
        div.setAttribute('data-type', item.type);
        div.setAttribute('data-qtext', item.q);
        div.setAttribute('data-index', index);
        div.innerHTML = `
            <span style="font-size:1rem; font-weight:bold; display:block; margin-bottom:10px; color:#2c3e50;">Q${index + 1}. ${item.q}</span>
            <div class="options">
                <label class="option-label"><input type="radio" name="q${index}" value="1"><div class="btn-text">전혀 아님</div></label>
                <label class="option-label"><input type="radio" name="q${index}" value="2"><div class="btn-text">아님</div></label>
                <label class="option-label"><input type="radio" name="q${index}" value="3"><div class="btn-text">보통</div></label>
                <label class="option-label"><input type="radio" name="q${index}" value="4"><div class="btn-text">그렇다</div></label>
                <label class="option-label"><input type="radio" name="q${index}" value="5"><div class="btn-text">매우 그렇다</div></label>
            </div>
        `;
        formContainer.appendChild(div);
    });

    function calculateResult() {
        let scores = { "1":0, "2":0, "3":0, "4":0, "5":0, "6":0, "7":0, "8":0, "9":0, "SQ":0 };
        let answeredCount = 0;
        let userResponses = [];

        const questionBoxes = document.querySelectorAll('.question-box');
        for (let box of questionBoxes) {
            const index = box.getAttribute('data-index');
            const type = box.getAttribute('data-type');
            const qText = box.getAttribute('data-qtext');
            const inputs = document.getElementsByName(`q${index}`);
            let value = 0;
            for (let input of inputs) {
                if (input.checked) { value = parseInt(input.value); break; }
            }
            if (value > 0) {
                answeredCount++;
                scores[type] += value;
                userResponses.push({ type: type, text: qText, score: value });
            }
        }

        if (answeredCount < shuffledQuestions.length) {
            alert(`답변하지 않은 문항이 있습니다. (${answeredCount}/${shuffledQuestions.length})`);
            return;
        }

        finalScores = scores;
        showResult(scores, userResponses);
    }

    function showResult(scores, userResponses) {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        window.scrollTo(0,0);

        document.getElementById('sq-score-text').innerText = scores['SQ'];

        let typeScores = [];
        for(let i=1; i<=9; i++) typeScores.push({ id: i.toString(), score: scores[i] });
        typeScores.sort((a, b) => b.score - a.score);

        const topType = typeScores[0];
        const topTypeId = parseInt(topType.id);
        const top3 = typeScores.slice(0, 3);
        const bottom3 = [...typeScores].reverse().slice(0, 3);

        let centerName = "";
        if ([8, 9, 1].includes(topTypeId)) centerName = "장형 (본능 중심)";
        else if ([2, 3, 4].includes(topTypeId)) centerName = "가슴형 (감정 중심)";
        else centerName = "머리형 (사고 중심)";

        const topTypeName = typeNamesMap[topTypeId];

        document.getElementById('result-main-title').innerHTML = 
            `<span style="color:#555; font-size:1.1rem; font-weight:normal;">${centerName}</span><br>${topTypeName} 성향`;

        let highHtml = "";
        top3.forEach((item, idx) => { highHtml += `<span>${idx+1}위: <b>${item.id}번</b> (${item.score}점)</span>`; });
        document.getElementById('high-rank-list').innerHTML = highHtml;

        let lowHtml = "";
        bottom3.forEach((item, idx) => { lowHtml += `<span>${idx+1}위: <b>${item.id}번</b> (${item.score}점)</span>`; });
        document.getElementById('low-rank-list').innerHTML = lowHtml;

        const ctx = document.getElementById('resultChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1번', '2번', '3번', '4번', '5번', '6번', '7번', '8번', '9번'],
                datasets: [{
                    label: '점수', data: [scores['1'], scores['2'], scores['3'], scores['4'], scores['5'], scores['6'], scores['7'], scores['8'], scores['9']],
                    backgroundColor: 'rgba(52, 73, 94, 0.7)', borderColor: 'rgba(44, 62, 80, 1)', borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: {duration: 0}, scales: {y: {beginAtZero: true, max: 50}} }
        });

        const tableBody = document.querySelector('#detail-table tbody');
        userResponses.sort((a, b) => {
            if (a.type === 'SQ') return 1; if (b.type === 'SQ') return -1;
            return parseInt(a.type) - parseInt(b.type);
        });
        userResponses.forEach(res => {
            const tr = document.createElement('tr');
            let typeColor = res.type === 'SQ' ? '#95a5a6' : '#2c3e50';
            let typeName = res.type === 'SQ' ? 'SQ' : res.type + '번';
            let scoreWeight = res.score >= 4 ? 'bold' : 'normal';
            tr.innerHTML = `<td style="text-align:center;"><span style="background:${typeColor}; color:white; padding:3px 6px; border-radius:4px; font-size:0.75rem;">${typeName}</span></td><td>${res.text}</td><td style="text-align:center; font-weight:${scoreWeight};">${res.score}</td>`;
            tableBody.appendChild(tr);
        });
    }

    function callAppsScript() {
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes("여기에_URL")) {
            alert("HTML 코드 상단에 Google Apps Script URL을 먼저 입력해주세요!");
            return;
        }

        document.getElementById('loading-overlay').style.display = 'flex';

        fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ scores: finalScores })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-overlay').style.display = 'none';

            if(data.error) {
                alert("분석 시스템 오류: " + data.error);
                return;
            }

            document.getElementById('ai-trigger-area').style.display = 'none';
            document.getElementById('ai-result-container').style.display = 'block';
            
            // 데이터 파싱
            document.getElementById('ai-strength').innerHTML = marked.parse(data.strength || "분석 내용 없음");
            document.getElementById('ai-weakness').innerHTML = marked.parse(data.weakness || "분석 내용 없음");
            document.getElementById('ai-advice').innerHTML = marked.parse(data.advice || "분석 내용 없음");
            
            // 모든 ai-box 보이기 (flex나 다른 속성이 있어도 강제 display block)
            document.querySelectorAll('.ai-box').forEach(el => el.style.display = 'block');
            
            document.getElementById('ai-result-container').scrollIntoView({behavior: "smooth"});
        })
        .catch(error => {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("서버 통신 오류가 발생했습니다.");
        });
    }

    function savePDF() {
        window.scrollTo(0, 0);
        const element = document.getElementById('pdf-content');
        const btn = document.getElementById('pdf-btn');
        btn.innerText = "저장 중...";
        
        const opt = {
            margin: [10, 10, 10, 10], 
            filename: 'KSIP_Psychological_Report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'legacy'] } 
        };
        
        html2pdf().set(opt).from(element).save().then(() => { btn.innerText = "PDF 보고서 저장"; });
    }
</script>

</body>
</html>